name: Unpack-GeoSite-From-Zip

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Create Unpacker Script
        run: |
          cat <<EOF > unpacker.go
          package main

          import (
          	"archive/zip"
          	"encoding/binary"
          	"fmt"
          	"io"
          	"log"
          	"os"
          	"path/filepath"
          	"strings"
          )

          func readVarint(r io.Reader) (uint64, error) {
          	var v uint64
          	var shift uint
          	for {
          		var b [1]byte
          		if _, err := r.Read(b[:]); err != nil {
          			return 0, err
          		}
          		v |= uint64(b[0]&0x7F) << shift
          		if b[0]&0x80 == 0 {
          			break
          		}
          		shift += 7
          	}
          	return v, nil
          }

          func main() {
          	zipPath := "source/geosite.zip"
          	outDir := "data"

          	// –û—Ç–∫—Ä—ã–≤–∞–µ–º ZIP –∞—Ä—Ö–∏–≤
          	r, err := zip.OpenReader(zipPath)
          	if err != nil { log.Fatalf("‚ùå –û—à–∏–±–∫–∞ ZIP: %v", err) }
          	defer r.Close()

          	var datReader io.ReadCloser
          	for _, f := range r.File {
          		if strings.HasSuffix(f.Name, "geosite.dat") {
          			datReader, err = f.Open()
          			if err != nil { log.Fatal(err) }
          			fmt.Printf("üì¶ –ù–∞—à–µ–ª %s –≤–Ω—É—Ç—Ä–∏ –∞—Ä—Ö–∏–≤–∞\n", f.Name)
          			break
          		}
          	}

          	if datReader == nil { log.Fatal("‚ùå geosite.dat –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ") }
          	defer datReader.Close()

          	_ = os.RemoveAll(outDir)
          	_ = os.MkdirAll(outDir, 0755)

          	for {
          		header, err := readVarint(datReader)
          		if err == io.EOF { break }
          		if err != nil { log.Fatal(err) }

          		if header>>3 != 1 { continue }

          		contentLen, _ := readVarint(datReader)
          		content := make([]byte, contentLen)
          		_, err = io.ReadFull(datReader, content)
          		if err != nil { log.Fatal(err) }

          		var catName string
          		var lines []string
          		pos := uint64(0)

          		for pos < contentLen {
          			tag, n := binary.Uvarint(content[pos:])
          			pos += uint64(n)
          			valLen, n := binary.Uvarint(content[pos:])
          			pos += uint64(n)
          			val := content[pos : pos+valLen]
          			pos += valLen

          			if tag>>3 == 1 {
          				catName = string(val)
          			} else if tag>>3 == 2 {
          				dPos := uint64(0)
          				for dPos < uint64(len(val)) {
          					dTag, dn := binary.Uvarint(val[dPos:])
          					dPos += uint64(dn)
          					dValLen, dln := binary.Uvarint(val[dPos:])
          					dPos += uint64(dln)
          					dVal := val[dPos : dPos+dValLen]
          					dPos += dValLen
          					if dTag>>3 == 2 {
          						lines = append(lines, string(dVal))
          					}
          				}
          			}
          		}

          		if catName != "" {
          			fmt.Printf("üìÇ –ò–∑–≤–ª–µ—á–µ–Ω–æ: %s (%d —Å—Ç—Ä–æ–∫)\n", catName, len(lines))
          			outPath := filepath.Join(outDir, strings.ToLower(catName))
          			f, _ := os.Create(outPath)
          			for _, line := range lines {
          				f.WriteString(line + "\n")
          			}
          			f.Close()
          		}
          	}
          }
          EOF

      - name: Run Unpacker
        run: go run unpacker.go

      - name: Push Results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git commit -m "Unpack from geosite.zip 1:1" || exit 0
          git push
