name: Unpack-GeoSite-Safe

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Extract ZIP
        run: |
          mkdir -p temp_extracted
          unzip source/geosite.zip -d temp_extracted/
          # Ð˜Ñ‰ÐµÐ¼, Ð³Ð´Ðµ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð»ÐµÐ¶Ð¸Ñ‚ Ñ„Ð°Ð¹Ð» (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð² Ð¿Ð¾Ð´Ð¿Ð°Ð¿ÐºÐ°Ñ…)
          find temp_extracted/ -name "geosite.dat" -exec cp {} ./geosite.dat \;
          echo "âœ… geosite.dat ready for processing"

      - name: Create Unpacker Script
        run: |
          cat <<EOF > unpacker.go
          package main

          import (
          	"encoding/binary"
          	"fmt"
          	"io"
          	"log"
          	"os"
          	"path/filepath"
          	"strings"
          )

          func readVarint(r io.Reader) (uint64, error) {
          	var v uint64
          	var shift uint
          	for {
          		var b [1]byte
          		if _, err := r.Read(b[:]); err != nil {
          			return 0, err
          		}
          		v |= uint64(b[0]&0x7F) << shift
          		if b[0]&0x80 == 0 {
          			break
          		}
          		shift += 7
          	}
          	return v, nil
          }

          func main() {
          	srcFile := "geosite.dat"
          	outDir := "data"

          	file, err := os.Open(srcFile)
          	if err != nil { log.Fatalf("âŒ Error: %v", err) }
          	defer file.Close()

          	_ = os.RemoveAll(outDir)
          	_ = os.MkdirAll(outDir, 0755)

          	for {
          		header, err := readVarint(file)
          		if err == io.EOF { break }
          		if err != nil { break }

          		// ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²ÑÐµ, Ñ‡Ñ‚Ð¾ Ð½Ðµ Field 1 (Category)
          		if header>>3 != 1 {
          			if header&0x7 == 2 {
          				l, _ := readVarint(file)
          				io.CopyN(io.Discard, file, int64(l))
          			}
          			continue
          		}

          		contentLen, _ := readVarint(file)
          		content := make([]byte, contentLen)
          		if _, err := io.ReadFull(file, content); err != nil { break }

          		var catName string
          		var lines []string
          		
          		offset := 0
          		for offset < len(content) {
          			tag, n := binary.Uvarint(content[offset:])
          			offset += n
          			valLen, n := binary.Uvarint(content[offset:])
          			offset += n
          			
          			end := offset + int(valLen)
          			if end > len(content) { break }
          			val := content[offset:end]
          			offset = end

          			fieldNum := tag >> 3
          			if fieldNum == 1 {
          				catName = string(val)
          			} else if fieldNum == 2 {
          				// Ð—Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð²Ð½ÑƒÑ‚Ñ€ÑŒ Ð´Ð¾Ð¼ÐµÐ½Ð°
          				dOff := 0
          				for dOff < len(val) {
          					dTag, dn := binary.Uvarint(val[dOff:])
          					dOff += dn
          					dLen, dln := binary.Uvarint(val[dOff:])
          					dOff += dln
          					
          					dEnd := dOff + int(dLen)
          					if dEnd > len(val) { break }
          					
          					data := val[dOff:dEnd]
          					// Ð’ÐÐ–ÐÐž: Ð±ÐµÑ€ÐµÐ¼ Ð»ÑŽÐ±Ð¾Ðµ Ð¿Ð¾Ð»Ðµ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÑÑ‚Ñ€Ð¾ÐºÑƒ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ 2, Ð½Ð¾ Ð±Ñ‹Ð²Ð°ÐµÑ‚ Ð¸ 1)
          					// Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¾Ð²ÑÐµÐ¼ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ðµ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ñ‚Ð¸Ð¿Ð° Ñ‚Ð¸Ð¿Ð° Ð´Ð¾Ð¼ÐµÐ½Ð°)
          					if len(data) > 1 {
          						lines = append(lines, string(data))
          					}
          					dOff = dEnd
          				}
          			}
          		}

          		if catName != "" && len(lines) > 0 {
          			fmt.Printf("ðŸ“‚ Unpacking: %-25s | Lines: %d\n", catName, len(lines))
          			outPath := filepath.Join(outDir, strings.ToLower(catName))
          			f, _ := os.Create(outPath)
          			for _, line := range lines {
          				f.WriteString(line + "\n")
          			}
          			f.Close()
          		}
          	}
          }
          EOF

      - name: Run Unpacker
        run: go run unpacker.go

      - name: Commit Data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git commit -m "Unpack geosite.dat 1:1" || exit 0
          git push
