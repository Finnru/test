name: Unpack-GeoSite-Official-Final

on:
  workflow_dispatch: # Кнопка ручного запуска в Actions

permissions:
  contents: write

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Важно для работы Git Pull

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install v2dat
        run: go install github.com/urlesistiana/v2dat@latest

      - name: Sync, Unpack and Push
        run: |
          # 1. Настройка Git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # 2. Очистка и Pull (чтобы не было ошибки rejected)
          git clean -fd data/ || true
          git pull origin main --rebase

          # 3. Работа с архивом
          mkdir -p temp_extracted
          unzip -o source/geosite.zip -d temp_extracted/
          # Ищем geosite.dat внутри (может быть в подпапках)
          find temp_extracted/ -name "geosite.dat" -exec cp {} ./geosite.dat \;
          echo "✅ geosite.dat готов к обработке"

          # 4. Распаковка через v2dat в промежуточную папку
          rm -rf output_raw && mkdir output_raw
          v2dat unpack geosite -o output_raw geosite.dat

          # 5. Очистка имен и фильтрация пустых файлов
          rm -rf data && mkdir -p data
          cd output_raw
          for f in geosite_*.txt; do
            [ -e "$f" ] || continue
            # Превращаем 'geosite_google.txt' в 'google'
            newname=$(basename "$f" | sed 's/^geosite_//;s/\.txt$//')
            
            # Копируем только если файл не пустой
            if [ -s "$f" ]; then
              cp "$f" "../data/$newname"
            fi
          done
          cd ..

          # 6. Коммит и отправка в репозиторий
          git add data/
          if git diff --staged --quiet; then
            echo "Нет изменений для коммита"
          else
            git commit -m "Unpack geosite 1:1 - clean names"
            git push origin main
          fi
